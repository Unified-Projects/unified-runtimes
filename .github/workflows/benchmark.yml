name: Benchmark

on:
    push:
        branches: ["main", "dev"]
    workflow_dispatch:
        inputs:
            duration:
                description: "Benchmark duration in seconds"
                required: false
                default: "30"
            runtime_image:
                description: "Runtime image to test with"
                required: false
                default: "openruntimes/node:v5-22"
            function:
                description: "Function type (node, nextjs)"
                required: false
                default: "node"

env:
    CARGO_TERM_COLOR: always
    BENCH_SECRET: benchmark-secret
    BENCH_DURATION: ${{ github.event.inputs.duration || '30' }}
    BENCH_RUNTIME_IMAGE: ${{ github.event.inputs.runtime_image || 'openruntimes/node:v5-22' }}
    BENCH_FUNCTION: ${{ github.event.inputs.function || 'node' }}
    BENCH_RUNTIME_TARGET: both
    BENCH_OUTPUT_JSON: benchmark_results.json

jobs:
    benchmark:
        name: Performance Benchmark
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Pre-cleanup stale containers
              run: |
                  # Remove any stale containers and networks from previous runs
                  docker compose -f crates/urt-executor/docker-compose.test.yml \
                    --profile test --profile bench down -v --remove-orphans 2>/dev/null || true
                  docker ps -a --filter "label=urt.managed" -q | xargs -r docker rm -f 2>/dev/null || true
                  docker ps -a --filter "name=openruntimes-" -q | xargs -r docker rm -f 2>/dev/null || true
                  docker network rm e2e-test-network 2>/dev/null || true

            - name: Run dockerized benchmarks
              run: |
                  docker compose -f crates/urt-executor/docker-compose.test.yml \
                    --profile bench up --build --abort-on-container-exit --exit-code-from bench-runner

            - name: Capture benchmark output
              if: always()
              run: |
                  docker compose -f crates/urt-executor/docker-compose.test.yml \
                    logs --no-color bench-runner > benchmark_output.txt || true

                  BENCH_CONTAINER_ID=$(docker compose -f crates/urt-executor/docker-compose.test.yml ps -q bench-runner)
                  if [ -n "$BENCH_CONTAINER_ID" ]; then
                      docker cp "$BENCH_CONTAINER_ID:/app/${BENCH_OUTPUT_JSON}" "${BENCH_OUTPUT_JSON}" || true
                  fi

            - name: Upload results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: benchmark-results
                  path: |
                      benchmark_output.txt
                      benchmark_results.json
                  retention-days: 90

            - name: Show executor logs on failure
              if: failure()
              run: |
                  echo "=== URT Executor Logs ==="
                  docker compose -f crates/urt-executor/docker-compose.test.yml \
                    logs --no-color urt-executor | tail -100
                  echo ""
                  echo "=== OpenRuntimes Executor Logs ==="
                  docker compose -f crates/urt-executor/docker-compose.test.yml \
                    logs --no-color opr-executor | tail -100

            - name: Cleanup
              if: always()
              run: |
                  docker compose -f crates/urt-executor/docker-compose.test.yml down -v --remove-orphans 2>/dev/null || true
                  docker ps -a --filter "label=urt.managed" -q | xargs -r docker rm -f 2>/dev/null || true
                  docker ps -a --filter "name=openruntimes-" -q | xargs -r docker rm -f 2>/dev/null || true
                  docker network rm e2e-test-network 2>/dev/null || true
                  docker system prune -f 2>/dev/null || true
                  docker volume prune -f 2>/dev/null || true
                  rm -f benchmark_output.txt benchmark_results.json 2>/dev/null || true
