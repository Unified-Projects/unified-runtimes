name: CI

on:
    push:
        branches: ["main", "dev"]
    pull_request:
        branches: ["main", "dev"]

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Cache dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  cache-on-failure: true

            - name: Check formatting
              run: cargo fmt --all -- --check

            - name: Lint with Clippy
              run: cargo clippy --all-targets --all-features -- -D warnings

            - name: Cleanup
              if: always()
              run: |
                  cargo clean 2>/dev/null || true
                  rm -rf ~/.cargo/registry/cache 2>/dev/null || true

    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y pkg-config libssl-dev

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cache dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  cache-on-failure: true

            - name: Run unit tests
              run: cargo test --lib --verbose

            - name: Run doc tests
              run: cargo test --doc --verbose

            - name: Cleanup
              if: always()
              run: |
                  cargo clean 2>/dev/null || true
                  rm -rf ~/.cargo/registry/cache 2>/dev/null || true

    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y pkg-config libssl-dev

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cache dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  cache-on-failure: true

            - name: Build release
              run: cargo build --release --verbose

            - name: Upload binary
              uses: actions/upload-artifact@v4
              with:
                  name: urt-executor
                  path: target/release/urt-executor
                  retention-days: 7

            - name: Cleanup
              if: always()
              run: |
                  cargo clean 2>/dev/null || true
                  rm -rf ~/.cargo/registry/cache 2>/dev/null || true

    docker-build:
        name: Docker Build
        runs-on: ubuntu-latest
        outputs:
            image_tag: ${{ steps.build.outputs.image_tag }}
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              id: build
              run: |
                  IMAGE_TAG="urt-executor:ci-${{ github.sha }}"
                  docker build -t $IMAGE_TAG -f docker/Dockerfile .
                  echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

            - name: Cleanup
              if: always()
              run: |
                  docker rmi "urt-executor:ci-${{ github.sha }}" 2>/dev/null || true
                  docker system prune -f 2>/dev/null || true

    docker-tests:
        name: Docker Tests (Integration + E2E)
        runs-on: ubuntu-latest
        env:
            E2E_RUNTIME_IMAGE: openruntimes/node:v5-22
            E2E_TIMEOUT_SECS: 300
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Pull runtime image
              run: docker pull $E2E_RUNTIME_IMAGE

            - name: Pre-cleanup stale containers
              working-directory: crates/urt-executor
              run: |
                  # Remove any stale containers and networks from previous runs
                  docker compose -f docker-compose.test.yml --profile test --profile bench down -v --remove-orphans 2>/dev/null || true
                  docker ps -a --filter "label=urt.managed" -q | xargs -r docker rm -f 2>/dev/null || true
                  docker network rm e2e-test-network 2>/dev/null || true

            - name: Run dockerized tests
              working-directory: crates/urt-executor
              run: docker compose -f docker-compose.test.yml --profile test up --build --abort-on-container-exit

            - name: Cleanup
              if: always()
              working-directory: crates/urt-executor
              run: |
                  docker compose -f docker-compose.test.yml down -v --remove-orphans 2>/dev/null || true
                  docker ps -a --filter "label=urt.managed" -q | xargs -r docker rm -f 2>/dev/null || true
                  docker network rm e2e-test-network 2>/dev/null || true
                  docker system prune -f 2>/dev/null || true
                  docker volume prune -f 2>/dev/null || true
