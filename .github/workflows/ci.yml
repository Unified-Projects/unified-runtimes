name: CI

on:
    push:
        branches: ["main", "dev"]
        paths-ignore:
            - "**/*.md"
            - "LICENCE"
            - ".vscode/**"
            - ".editorconfig"
    pull_request:
        branches: ["main", "dev"]
        paths-ignore:
            - "**/*.md"
            - "LICENCE"
            - ".vscode/**"
            - ".editorconfig"

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1
    COMPOSE_PROJECT_NAME: urt-ci

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        permissions:
            contents: read
        if: github.event_name == 'push'
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
              with:
                  components: rustfmt, clippy

            - name: Cache dependencies
              uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
              with:
                  cache-on-failure: true

            - name: Check formatting
              run: cargo fmt --all -- --check

            - name: Lint with Clippy
              run: cargo clippy --all-targets --all-features -- -D warnings

            # No explicit cleanup: preserves rust-cache contents for faster CI

    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        permissions:
            contents: read
        needs: lint
        if: github.event_name == 'push'
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y pkg-config libssl-dev

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

            - name: Cache dependencies
              uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
              with:
                  cache-on-failure: true

            - name: Run unit tests
              run: cargo test --lib --verbose

            - name: Run doc tests
              run: cargo test --doc --verbose

            # No explicit cleanup: preserves rust-cache contents for faster CI

    build:
        name: Build
        runs-on: ubuntu-latest
        permissions:
            contents: read
        needs: test
        if: github.event_name == 'pull_request'
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y pkg-config libssl-dev

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

            - name: Cache dependencies
              uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
              with:
                  cache-on-failure: true

            - name: Build release
              run: cargo build --release --verbose

            - name: Upload binary
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
              with:
                  name: urt-executor
                  path: target/release/urt-executor
                  retention-days: 7

            # No explicit cleanup: preserves rust-cache contents for faster CI

    docker-build:
        name: Docker Build
        runs-on: ubuntu-latest
        permissions:
            contents: read
        outputs:
            image_tag: ${{ steps.image.outputs.image_tag }}
        needs: build
        if: github.event_name == 'pull_request'
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

            - name: Set image tag
              id: image
              run: echo "image_tag=urt-executor:ci-${{ github.sha }}" >> $GITHUB_OUTPUT

            - name: Build Docker image (multi-arch)
              uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
              with:
                  context: .
                  file: docker/Dockerfile
                  platforms: linux/amd64,linux/arm64
                  tags: ${{ steps.image.outputs.image_tag }}
                  push: false
                  outputs: type=oci,dest=/tmp/urt-executor.tar
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Cleanup
              if: always()
              run: |
                  rm -f /tmp/urt-executor.tar 2>/dev/null || true
                  docker system prune -f 2>/dev/null || true

    docker-tests:
        name: Docker Tests (Integration + E2E)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        needs: docker-build
        if: github.event_name == 'pull_request'
        env:
            E2E_RUNTIME_IMAGE: openruntimes/node:v5-22
            E2E_TIMEOUT_SECS: 300
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

            - name: Pull runtime image
              run: docker pull $E2E_RUNTIME_IMAGE

            - name: Build test-runner image (cached)
              uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
              with:
                  context: .
                  file: crates/urt-executor/Dockerfile.test
                  tags: ${{ env.COMPOSE_PROJECT_NAME }}-test-runner:latest
                  load: true
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Pre-cleanup stale containers
              working-directory: crates/urt-executor
              run: |
                  # Remove any stale containers and networks from previous runs
                  docker compose -f docker-compose.test.yml --profile test --profile bench down -v --remove-orphans 2>/dev/null || true
                  docker ps -a --filter "label=urt.managed" -q | xargs -r docker rm -f 2>/dev/null || true
                  docker network rm e2e-test-network 2>/dev/null || true

            - name: Run dockerized tests
              working-directory: crates/urt-executor
              run: docker compose -p "${{ env.COMPOSE_PROJECT_NAME }}" -f docker-compose.test.yml --profile test up --no-build --abort-on-container-exit

            - name: Cleanup
              if: always()
              working-directory: crates/urt-executor
              run: |
                  docker compose -f docker-compose.test.yml down -v --remove-orphans 2>/dev/null || true
                  docker ps -a --filter "label=urt.managed" -q | xargs -r docker rm -f 2>/dev/null || true
                  docker network rm e2e-test-network 2>/dev/null || true
                  docker system prune -f 2>/dev/null || true
                  docker volume prune -f 2>/dev/null || true
