name: CodeQL

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - main
      - dev

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v3
        with:
          languages: rust, actions
          queries: security-and-quality

      # Explicit build is more reliable than autobuild for Rust
      - name: Build project
        run: cargo build --all-features

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v3

      - name: Cleanup
        if: always()
        run: |
          rm -rf ~/.codeql 2>/dev/null || true

  rust-security-audit:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo-audit (JSON)
        run: cargo audit --json > audit-results.json

      - name: Parse audit results
        id: audit
        run: |
          VULN_COUNT=$(jq '.vulnerabilities.count // 0' audit-results.json)
          echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "## ðŸš¨ Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Found $VULN_COUNT vulnerabilities:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '.vulnerabilities.list' audit-results.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… No Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on vulnerabilities
        if: steps.audit.outputs.vulnerability_count > 0
        run: |
          echo "Found ${{ steps.audit.outputs.vulnerability_count }} security vulnerabilities!"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f audit-results.json 2>/dev/null || true
          rm -rf ~/.cargo/registry/cache 2>/dev/null || true

  license-check:
    name: License Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Check licenses and advisories
        run: cargo deny check

      - name: Cleanup
        if: always()
        run: |
          rm -rf ~/.cargo/registry/cache 2>/dev/null || true
