name: CodeQL

on:
    push:
        branches: ["main", "dev"]
    pull_request:
        branches: ["main", "dev"]
    schedule:
        # Run weekly on Sundays at 00:00 UTC
        - cron: "0 0 * * 0"

jobs:
    analyze-actions:
        name: Analyze Actions
        runs-on: ubuntu-latest
        timeout-minutes: 60
        continue-on-error: true
        permissions:
            security-events: write
            packages: read
            actions: read
            contents: read

        steps:
            - name: Checkout repository
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Initialize CodeQL
              uses: github/codeql-action/init@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
              with:
                  languages: actions
                  queries: security-and-quality

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
              with:
                  category: "/language:actions"

            - name: Cleanup
              if: always()
              run: |
                  rm -rf ~/.codeql 2>/dev/null || true

    rust-security-audit:
        name: Rust Security Audit
        runs-on: ubuntu-latest
        permissions:
            security-events: write
            contents: read

        steps:
            - name: Checkout repository
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

            - name: Install cargo-audit
              run: cargo install cargo-audit --locked

            - name: Run cargo-audit
              run: cargo audit --json > audit-results.json || true

            - name: Parse audit results
              id: audit
              run: |
                  if [ -f audit-results.json ]; then
                      VULN_COUNT=$(jq '.vulnerabilities.count // 0' audit-results.json)
                      echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT

                      if [ "$VULN_COUNT" -gt 0 ]; then
                          echo "## Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
                          echo "" >> $GITHUB_STEP_SUMMARY
                          echo "Found $VULN_COUNT vulnerabilities in dependencies:" >> $GITHUB_STEP_SUMMARY
                          echo "" >> $GITHUB_STEP_SUMMARY
                          echo '```json' >> $GITHUB_STEP_SUMMARY
                          jq '.vulnerabilities.list' audit-results.json >> $GITHUB_STEP_SUMMARY
                          echo '```' >> $GITHUB_STEP_SUMMARY
                      else
                          echo "## No Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
                      fi
                  fi

            - name: Fail on vulnerabilities
              if: steps.audit.outputs.vulnerability_count > 0
              run: |
                  echo "Found ${{ steps.audit.outputs.vulnerability_count }} security vulnerabilities!"
                  cargo audit
                  exit 1

            - name: Cleanup
              if: always()
              run: |
                  rm -f audit-results.json 2>/dev/null || true
                  rm -rf ~/.cargo/registry/cache 2>/dev/null || true

    license-check:
        name: License Check
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout repository
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

            - name: Install cargo-deny
              run: cargo install cargo-deny --locked

            - name: Check licenses and advisories
              run: cargo deny check || true

            - name: Cleanup
              if: always()
              run: |
                  rm -rf ~/.cargo/registry/cache 2>/dev/null || true
