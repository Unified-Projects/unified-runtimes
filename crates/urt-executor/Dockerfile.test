# Dockerfile for running all tests inside Docker
# This allows tests to communicate with containers on the Docker network
# IMPORTANT: E2E tests MUST run inside Docker for proper DNS resolution between containers

FROM rust:latest

# Install Docker CLI (to communicate with host Docker daemon) and Apache Bench for benchmarks
RUN apt-get update && apt-get install -y \
    docker.io \
    apache2-utils \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy workspace files
COPY Cargo.toml Cargo.lock ./
COPY crates ./crates

# Build all tests including e2e
RUN cargo build --package urt-executor --tests

# Default: run all tests (unit, integration, e2e) but NOT benchmarks
# E2E tests require Docker socket access and network connectivity
# The test-runner container is on the same Docker network as runtime containers
CMD ["cargo", "test", "--package", "urt-executor", "--", "--test-threads=1"]
