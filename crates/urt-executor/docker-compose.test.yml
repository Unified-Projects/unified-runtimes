services:
  # MinIO for S3 storage tests
  minio:
    profiles: ["test"]
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - e2e-test-network

  # Test runner container
  test-runner:
    profiles: ["test"]
    build:
      context: ../..
      dockerfile: crates/urt-executor/Dockerfile.test
    volumes:
      # Mount Docker socket so tests can create containers
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp:/tmp
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - RUST_LOG=info
      - RUST_BACKTRACE=1
      # Pass the HOST path to fixtures so containers created via socket can mount them
      - TEST_FIXTURES_HOST_PATH=${PWD}/tests/fixtures
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - e2e-test-network

  # ==========================================================================
  # Benchmark services (optional, for running benchmarks in Docker)
  # Start with: docker compose -f docker-compose.test.yml --profile bench up
  # ==========================================================================

  # URT Executor (for benchmarks)
  urt-executor:
    profiles: ["bench"]
    build:
      context: ../..
      dockerfile: docker/Dockerfile
    environment:
      - URT_HOST=0.0.0.0
      - URT_PORT=80
      - URT_SECRET=${URT_SECRET:-${BENCH_SECRET:-benchmark-secret}}
      - URT_NETWORK=e2e-test-network
      - URT_KEEP_ALIVE=true
      - URT_IMAGE_PULL=enabled
      - RUST_LOG=info
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp:/tmp
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sf -H \"Authorization: Bearer $$URT_SECRET\" -H \"x-open-runtimes-secret: $$URT_SECRET\" http://localhost:80/v1/health",
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - e2e-test-network

  # Benchmark runner (uses the executor services above)
  bench-runner:
    profiles: ["bench"]
    build:
      context: ../..
      dockerfile: crates/urt-executor/Dockerfile.test
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - RUST_LOG=info
      - RUST_BACKTRACE=1
      # Benchmark configuration - use service names for Docker networking
      - URT_URL=http://urt-executor:80
      - BENCH_SECRET=${BENCH_SECRET:-benchmark-secret}
      - URT_SECRET=${URT_SECRET:-${BENCH_SECRET:-benchmark-secret}}
      - BENCH_DURATION=${BENCH_DURATION:-30}
      - BENCH_WARMUP=${BENCH_WARMUP:-3}
      - BENCH_TIMEOUT=${BENCH_TIMEOUT:-30}
      - BENCH_RUNTIME_IMAGE=${BENCH_RUNTIME_IMAGE:-openruntimes/node:v5-22}
      - BENCH_FUNCTION=${BENCH_FUNCTION:-node}
      - BENCH_OUTPUT_JSON=${BENCH_OUTPUT_JSON:-benchmark_results.json}
    command: ["cargo", "bench", "--package", "urt-executor", "--bench", "benchmark"]
    depends_on:
      urt-executor:
        condition: service_healthy
    networks:
      - e2e-test-network

networks:
  # Use explicit name so tests can reference it without compose prefix
  e2e-test-network:
    name: e2e-test-network
    driver: bridge
